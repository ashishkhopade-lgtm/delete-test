name: Notify File Deletions
on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  if_merged:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Deletion Summary
        id: summary
        run: |
          # 1. Puri tarah delete hui files ki list
          DELETED_FILES=$(git diff --name-status HEAD^1 HEAD | awk '$1 == "D" {print "‚ùå [DELETED] " $2}')
          
          # 2. Files jinmein se sirf lines delete hui hain
          LINES_REMOVED=$(git diff --numstat HEAD^1 HEAD | while read added deleted file; do
            if [ "$deleted" -gt 0 ]; then
              status=$(git diff --name-status HEAD^1 HEAD -- "$file" | awk '{print $1}')
              if [ "$status" != "D" ]; then
                echo "üìâ $file : $deleted lines removed"
              fi
            fi
          done)

          # Dono ko combine karein
          FINAL_SUMMARY=""
          if [ ! -z "$DELETED_FILES" ]; then
            FINAL_SUMMARY="$DELETED_FILES"
          fi
          
          if [ ! -z "$LINES_REMOVED" ]; then
            if [ ! -z "$FINAL_SUMMARY" ]; then FINAL_SUMMARY="$FINAL_SUMMARY"$'\n'; fi
            FINAL_SUMMARY="$FINAL_SUMMARY$LINES_REMOVED"
          fi

          # Agar kuch bhi delete nahi hua, toh output empty rahega
          echo "diff_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$FINAL_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Google Chat
        # YEAH CONDITION CHECK KAREGI: Agar summary empty nahi hai, tabhi notification bhej‡•ã
        if: steps.summary.outputs.diff_summary != ''
        run: |
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

          curl --location --request POST '${{ secrets.GOOGLE_CHAT_WEBHOOK }}' \
          --header 'Content-Type: application/json' \
          --data-raw "{
            \"text\": \"‚úÖ *Merge Summary (Deletions)*\\nüë§ *By:* ${{ github.actor }}\\nüåø *Branch:* \`${{ github.event.pull_request.head.ref }}\`\\n\\nüìä *Files Changed:*\\n\`\`\`\\n${{ steps.summary.outputs.diff_summary }}\\n\`\`\`\\n\\nüîó *View Detailed Changes:* $COMMIT_URL\"
          }"